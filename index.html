<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <meta name="description" content="Create your place, put a pixel and defend your creations">
    <meta name="keywords" content="Place, pixelsgame">
    <meta name="author" content="Niji Ano">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">

    <meta property="og:image" content="img/favicon.png" />

    <title>Place by Anoniji</title>
    <script src="./js/jquery-3.6.1.min.js"></script>
    <script src="./js/jquery-ui.min.js"></script>
    <script src="./js/jquery.ui.touch-punch.js"></script>
    <script src="./js/js-snackbar.min.js"></script>
    <script src="./js/colorPick.min.js"></script>

    <link rel="icon" type="image/png" href="img/favicon.png" />

    <link rel="stylesheet" href="./css/app.css">
    <link rel="stylesheet" href="./css/js-snackbar.min.css">
    <link rel="stylesheet" href="./css/colorPick.min.css">
    <link rel="stylesheet" href="./css/colorPick.dark.theme.css">

    <style type="text/css">
        @font-face{
            font-family: "FeltTipSenior";
            src: url("./font/FeltTipSenior.eot");
            src: url("./font/FeltTipSenior.eot?#iefix") format("embedded-opentype"),url("./font/FeltTipSenior.woff") format("woff"),url("./font/FeltTipSenior.woff2") format("woff2"),url("./font/FeltTipSenior.ttf") format("truetype"),url("./font/FeltTipSenior.svg#FeltTipSenior") format("svg");
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            margin: 0;
            padding: 0;
            color: #000;
            background-color: #1c2024;
            overflow: hidden;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
        }

        #place {
            position: fixed;
            z-index: 10;
            border: 1px solid rgba(0, 0, 0, .2);
        }

        .rth {
            opacity: .2;
            position: fixed;
            z-index: 100;
            bottom: 0;
            right: 0;
            border-top: 1px solid #000000;
            border-left: 1px solid #000000;
            border-right: none;
            border-bottom: none;
            border-radius: 6px 0 0 0;
            padding: 4px 8px;
            line-height: 15px;
            font-size: 12px;
            background-color: #111416;
            color: #ffffff;
            transition: all .3s;
            cursor: pointer;
            user-select: none;
        }

        #cr {
            position: fixed;
            width: 300px !important;
            top: 0;
            height: 40px;
            right: 25px;
            font-size: 14px !important;
            padding: 4px !important;
        }

        #logout {
            position: fixed;
            width: 300px !important;
            top: 0;
            height: 40px;
            left: 25px;
            font-size: 14px !important;
            padding: 4px !important;
        }

        .action {
            opacity: .1;
            background-color: #111416;
            color: #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 34px;
            transition: all .3s;
            cursor: pointer;
            user-select: none;
            padding: 0;
            margin: 0;
        }

        .action img {
            width: 33px;
            margin-top: 7px;
            user-select: none;
        }

        #return_home {
            position: fixed;
            z-index: 100;
            bottom: 308px;
            left: 12px;
        }

        #stopMove {
            position: fixed;
            opacity: .9;
            z-index: 100;
            bottom: 248px;
            left: 12px;
        }

        #razPos {
            position: fixed;
            z-index: 100;
            bottom: 188px;
            left: 12px;
        }

        #zoomUp {
            position: fixed;
            z-index: 100;
            bottom: 128px;
            left: 12px;
        }

        #zoomDown {
            position: fixed;
            z-index: 100;
            bottom: 68px;
            left: 12px;
        }

        #overlay {
            position: fixed;
            top: 15px;
            left: 15px;
        }

        #overlay_add {
            position: fixed;
            opacity: 0.2;
            z-index: 100;
            bottom: 8px;
            left: 12px;
        }

        #overlay_checked {
            position: fixed;
            display: none;
            opacity: 0.9;
            z-index: 100;
            bottom: 8px;
            left: 72px;
        }

        #px_info {
            opacity: 0;
            position: fixed;
            z-index: 10000;
            background-color: #111416;
            color: #fff;
            border-radius: 8px;
            margin: 25px 0 0 25px;
            padding: 8px 12px;
            font-size: 12px;
        }

        #wip {
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            background-color: #111416;
            color: #fff;
            border-radius: 0 0 8px 0;
            border-bottom: 5px solid #ff000052;
            height: 52px;
            line-height: 52px;
            font-size: 18px;
            user-select: none;
            padding: 0 92px 0 15px;
            display: none;
        }

        .rth:hover, .action:hover {
            opacity: .9;
        }

        #go_place {
            display: none;
        }

        #home {
            position: fixed;
            text-align: center;
            left: calc(50% - 150px);
            top: calc(50% - 150px);
            width: 300px;
            height: 300px;
            padding: 8px;
            z-index: 10;
        }

        #home img {
            width: 128px;
            height: 128px;
        }

        #home .title {
            font-family: "FeltTipSenior";
            color: rgba(254, 254, 254, .8);
            margin: 8px 0 14px;
            font-size: 60px;
            opacity: 0;
            line-height: 65px;
        }

        #home button {
            border: 1px solid #000000;
            border-radius: 0 0 6px 6px;
            padding: 8px;
            line-height: 19px;
            font-size: 16px;
            background-color: #111416;
            color: rgba(254, 254, 254, .8);
            width: 100%;
        }

        #go_auth, #go_gest {
            border-radius: 6px !important;
            cursor: pointer;
        }

        #go_gest {
            margin-top: 8px;
        }

        #poss_info {
            position: fixed;
            right: 8px;
            top: 3px;
            font-size: 8px;
            color: #fff;
        }

        #new_session {
            text-align: center;
            border: 1px solid #000000;
            border-radius: 6px 6px 0 0;
            padding: 8px;
            line-height: 19px;
            width: calc(100% - 18px);
            display: none;
        }

        #session {
            display: none;
        }

        #color_selector {
            position: fixed;
            z-index: 100;
            top: 15px;
            left: 15px;
        }

        .blur {
            filter: blur(3px);
            backdrop-filter: blur(3px);
            box-shadow: 0px 0px 3px grey;
        }

        .js-snackbar__message {
            user-select: none;
        }

        .js-snackbar__close {
            display: none !important;
        }

        .js-snackbar__message-wrapper {
            margin-right: 5px;
        }

        #mode {
            position: fixed;
            top: 18px;
            right: 25px;
            font-size: 25px;
            opacity: 0.08;
        }

        #creator {
            position: fixed;
            top: 13px;
            left: 68px;
            z-index: 100;
            transition: all .3s;
            opacity: .1;
        }

        #creator:hover {
            opacity: 1.0;
        }

        #creator input {
            background-color: #111416;
            color: #fff;
            border: 1px solid #000;
            width: 50px;
            height: 36px;
            text-align: center;
        }

        #creator button {
            background-color: #6e6e6e;
            color: #fff;
            border: 1px solid #000;
            height: 40px;
            text-align: center;
            cursor: pointer;
            padding: 0 14px;
        }

        #helper {
            position: fixed;
            z-index: 10000;
            left: 70px;
            bottom: 5px;
            background-color: #111416;
            color: #fff;
            border-radius: 5px;
            padding-right: 25px;
            padding-left: 15px;
            display: none;
            user-select: none;
        }

        #helper ul {
            padding: 0;
            margin: 0;
        }

        #helper li {
            padding: 6px 0 0 0;
            line-height: 54px;
        }

        .colorPickSelector {
            border-radius: 5px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            -webkit-transition: all linear .2s;
            -moz-transition: all linear .2s;
            -ms-transition: all linear .2s;
            -o-transition: all linear .2s;
            transition: all linear .2s;
        }
        .colorPickSelector:hover { transform: scale(1.1); }

        .ui-resizable {
            position: relative;
        }
        .ui-resizable-handle {
            position: absolute;
            font-size: 0.1px;
            display: block;
            -ms-touch-action: none;
            touch-action: none;
        }
        .ui-resizable-disabled .ui-resizable-handle,
        .ui-resizable-autohide .ui-resizable-handle {
            display: none;
        }
        .ui-resizable-n {
            cursor: n-resize;
            height: 7px;
            width: 100%;
            top: -5px;
            left: 0;
        }
        .ui-resizable-s {
            cursor: s-resize;
            height: 7px;
            width: 100%;
            bottom: -5px;
            left: 0;
        }
        .ui-resizable-e {
            cursor: e-resize;
            width: 7px;
            right: -5px;
            top: 0;
            height: 100%;
        }
        .ui-resizable-w {
            cursor: w-resize;
            width: 7px;
            left: -5px;
            top: 0;
            height: 100%;
        }
        .ui-resizable-se {
            cursor: se-resize;
            width: 12px;
            height: 12px;
            right: 1px;
            bottom: 1px;
        }
        .ui-resizable-sw {
            cursor: sw-resize;
            width: 9px;
            height: 9px;
            left: -5px;
            bottom: -5px;
        }
        .ui-resizable-nw {
            cursor: nw-resize;
            width: 9px;
            height: 9px;
            left: -5px;
            top: -5px;
        }
        .ui-resizable-ne {
            cursor: ne-resize;
            width: 9px;
            height: 9px;
            right: -5px;
            top: -5px;
        }
    </style>
</head>

<body>
    <div id="wip">
        <span class="key_01">Maintenance in progress</span>
        <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
    </div>

    <section id="home">
        <img src="./img/favicon.png">
        <div class="title">Place</div>
        <input type="text" id="new_session" placeholder="Session name ?">
        <div>
            <button id="go_place" class="key_03">Go to my Place</button>
            <button id="go_auth" class="key_04" onclick="getAuthDiscord();">Authentication with Discord</button>
            <button id="go_gest" class="key_05" onclick="getAuthGuest();">Guest account</button>
        </div>

        <button id="cr" class="rth key_06" onclick="goMainSite();">created by Anoniji</button>
    </section>

    <section id="session">

        <div id="actions">
            <input id="fileid" type="file" accept="image/*" hidden/>

            <button class="action" id="return_home" onclick="return_home();">
                <img src="./img/home_icon.png">
            </button>
            <button class="action" id="stopMove" onclick="toggleDraggablePlace();">
                <img src="./img/move_icon.png">
            </button>
            <button class="action" id="razPos" onclick="razPos();">
                <img src="./img/c_icon.png">
            </button>
            <button class="action" id="zoomUp" onclick="zoomUp();">
                <img src="./img/p_icon.png">
            </button>
            <button class="action" id="zoomDown" onclick="zoomDown();">
                <img src="./img/m_icon.png">
            </button>
            <button class="action" id="overlay_add" onclick="openDialog();">
                <img src="./img/gallery_icon.png">
            </button>
            <button class="action" id="overlay_checked" onclick="overlay_checked();">
                <img src="./img/checked_icon.png">
            </button>
        </div>

        <div id="creator"></div>

        <div id="overlay">
            <img width="100%" height="100%" >
        </div>
        <canvas id="place"></canvas>
        <div id="color_selector" class="colorPickSelector"></div>
        <div id="poss_info"></div>
        <div id="px_info"></div>

        <div id="mode"></div>

        <div id="helper">
            <ul>
                <li class="key_07">Back to Home</li>
                <li class="key_08">Enable/Disable Place movement</li>
                <li class="key_09">Move the Place to the top left</li>
                <li class="key_10">Increase zoom</li>
                <li class="key_11">Decrease zoom</li>
                <li class="key_12">Add a overlay</li>
            </ul>
        </div>

        <button class="rth key_13" onclick="helper();">show/hide help</button>
    </section>
</body>

<script type="text/javascript">
    "fr"!=(language=navigator.language.split("-")[0])&&(language="en")
    var langpak;
    $.ajax({
        url: '/langs/' + language + '.json',
        async: false,
        dataType: 'json',
        success: function(response) {
            langpak = response;
            if(language != "en") {
                $("#new_session").attr("placeholder", langpak["key_02"]);
            }
            $.each(langpak, function(index, value){
                $("." + index).html(value);
            });
        }
    });

    function getRandomInt(n){return Math.floor(Math.random()*n)}
    function resetOverlay(){
        $("#overlay").css({'width': 0, 'height': 0, 'top': '15px', 'left': '15px'});
        $("#overlay_checked").hide();
        $("#overlay_add").html('<img src="./img/gallery_icon.png">').attr('onclick', 'openDialog();').css({'opacity': .2});
        $('#overlay img').removeAttr('src');
        $('#fileid').val('');
        $("#place").fadeIn(300);
        $("#overlay").draggable("enable").resizable("enable");
    }
    function overlay_checked() {
        $("#overlay_checked").hide();
        $("#place").fadeIn(300);
        $("#overlay").draggable("disable").resizable("disable");
    }

    function helper(argument) {
        $("#helper").fadeToggle(300);
    }

    // overlay ------------------------------------------>
    var _URL = window.URL || window.webkitURL;
    var file, img;
    function openDialog(){document.getElementById("fileid").click()}
    $("#fileid").change(function(e) {
        if ((file = this.files[0])) {
            img = new Image();
            img.onload = function() {
                $("#overlay").css({'top': '0px', 'left': '0px', 'width': parseInt(this.width, 10), 'height': parseInt(this.height, 10)});
            };
            img.onerror = function() {
                SnackBar({
                    fixed: true,
                    position: 'bc',
                    message: langpak['key_144'] + type,
                    status: "danger"
                });
            };
            img.src = _URL.createObjectURL(file)
            $("#overlay_checked").show();
            $('#overlay img').attr('src', img.src);
            $("#overlay_add").html('<img src="./img/recyclebin_icon.png">').attr('onclick', 'resetOverlay();').css({'opacity': .9});
            $("#place").fadeOut(300);
        }
    });
    $("#overlay").draggable().resizable({
        aspectRatio: true,
    });

    // overlay ------------------------------------------>

    function getLogout(){localStorage.removeItem("id"),localStorage.removeItem("username"),localStorage.removeItem("email"),location.href="/"}
    function getAuthDiscord(){location.href="..."}
    function getAuthGuest(){var e="guest_"+getRandomInt(5e5).toString();localStorage.setItem("id",e),localStorage.setItem("username",e),localStorage.setItem("email",e+"@..."),location.href="/"}
    function getPlace(){window.location.hash="#"+$("#new_session").val(),location.reload()}
    function goMainSite(){location.href="..."}
    function new_size() {
        const nw = $("#new_size_x").val();
        const nh = $("#new_size_y").val();
        wsocket.send("size;"+user+";"+session+";"+nw.toString()+";"+nh.toString());
    }
    function razPos() {
        position = '70;68';
        localStorage.setItem("position", position);
        $("#place").animate({left:"70px", top:"68px"}, 300);
    }

    function write_mode(mde) {
        wsocket.send("writing;"+user+";"+session+";"+mde);
    }

    function clear_place() {
        wsocket.send("clear;"+user+";"+session);
    }

    function return_home() {
        window.location.hash = "";
        location.reload();
    }


    eta_draggable = true;
    function toggleDraggablePlace() {
        if(eta_draggable) {
            $("#stopMove").animate({opacity:0.1},150);
            $('#place').draggable('disable');
            eta_draggable = false;
        } else {
            $("#stopMove").animate({opacity:0.8},150);
            $('#place').draggable('enable');
            eta_draggable = true;
        }
    }

    // load place
    var pseudo = localStorage.getItem("username");
    var user = localStorage.getItem("id");

    if(!user) {
        $("#home .title").delay(500).animate({opacity:1},300);
    } else {
        user = user.toString();
    }

    if(window.location.hash) {
        if(!user) {
            localStorage.setItem("redirect", window.location.hash);
            window.location.hash = "";
            location.reload();
        }
        $("#home").remove();
        $(document).keypress(function(event){
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if(keycode == '114') {
                window.location.hash = "";
                location.reload();
            }
        });

        // init
        var c=$("#place"),ctx=c[0].getContext("2d");
        var px_x=200,px_y=100,place_current_size=[0,0],initColor="#2196f3",currentColor=initColor;
        saveColor=localStorage.getItem("color"),saveColor&&(initColor=saveColor);
        var session = window.location.hash.substring(1);
        var writing, dragposition,position,zoom,mouseX,mouseY,clicked=!0,delayZoom=50,currentZoom=5,maxZoom=24,minZoom=3;
        var wss_url = "wss://wss-place.anoniji.dev";
        // ws init
        var wsocket = new WebSocket(wss_url);

        wsocket.onmessage = (event) => {
            ws_data = event.data;
            if(ws_data.startsWith('place_error')) {
                error = ws_data.split(';')[1];
                SnackBar({
                    fixed: true,
                    position: 'bc',
                    message: langpak['key_15'] + error,
                    status: "danger"
                });
            } else if(ws_data.startsWith('place_data')) {
                wip_eta = ws_data.split(';')[1];
                place_data = JSON.parse(ws_data.split(';')[2]);
                place_mode = place_data["mode"];
                data = place_data["data"];
                px_x = place_data["width"];
                px_y = place_data["height"];
                writing = place_data["writing"];
                creator = place_data["creator"];
                if(wip_eta == "T"){
                    $("#wip").fadeIn(300);
                }

                if(place_mode == "time") {
                    $("#mode").html('<img src="./img/mode_time_icone.png">');
                } else if(place_mode == "price") {
                    $("#mode").html('<img src="./img/mode_price_icone.png">');
                }

                if(creator == user) {
                    html = '<input id="new_size_x" type="number" min="' + px_x + '" value="' + px_x + '" size="4" />';
                    html += '<input id="new_size_y" type="number" min="' + px_y + '" value="' + px_y + '" size="4" />';
                    html += '<button onclick="new_size();">' + langpak['key_16'] + '</button>';

                    if(writing) {
                        html += '<button onclick="write_mode(\'F\');">' + langpak['key_17'] +'</button>';
                    } else {
                        html += '<button onclick="write_mode(\'T\');">' + langpak['key_18'] + '</button>';
                    }
                    html += '<button onclick="clear_place();">' + langpak['key_19'] + '</button>';
                    $("#creator").append(html);
                }

                place_current_size = place_draw(ctx, data, currentZoom, px_x, px_y, place_current_size, true, false);
                SnackBar({
                    fixed: true,
                    position: 'bc',
                    message: langpak['key_20'],
                    status: "success"
                });
                SnackBar({
                    fixed: true,
                    position: 'tc',
                    message: langpak['key_21'] + pseudo,
                    status: "info"
                });

                if(!writing) {
                    SnackBar({
                        fixed: true,
                        position: 'bc',
                        message: langpak['key_22'],
                        status: "info",
                        timeout: 0
                    });
                    $("#overlay_add").remove();
                    $("#stopMove").css("bottom","188px");
                    $("#razPos").css("bottom","128px");
                    $("#zoomUp").css("bottom","68px");
                    $("#zoomDown").css("bottom","8px");
                }
            } else if(ws_data.startsWith('new_size')) {
                place_data = ws_data.split(';');
                from_session = place_data[1];
                if(from_session == session) {
                    px_x = place_data[2];
                    px_y = place_data[3];
                    place_current_size = place_draw(ctx, data, currentZoom, px_x, px_y, place_current_size, true, false);
                    SnackBar({
                        fixed: true,
                        position: 'bc',
                        message: langpak['key_23'],
                        status: "info"
                    });
                }
            } else if(ws_data.startsWith('new_px')) {
                lst_data = ws_data.split(';');
                p_sess = lst_data[2];
                if (session == p_sess) {
                    p_user = lst_data[1];
                    p_poss = lst_data[3];
                    p_data = lst_data[4];
                    p_data = JSON.parse(p_data);
                    data[p_poss] = p_data;
                    place_current_size = place_draw(ctx, data, currentZoom, px_x, px_y, place_current_size, false, false);
                }
            } else if(ws_data.startsWith('del_px')) {

                lst_data = ws_data.split(';');
                p_sess = lst_data[2];
                if (session == p_sess) {
                    p_user = lst_data[1];
                    p_poss = lst_data[3];
                    delete data[p_poss];
                    place_current_size = place_draw(ctx, data, currentZoom, px_x, px_y, place_current_size, false, false);
                }

            } else if(ws_data.startsWith('write_change')) {
                lst_data = ws_data.split(';');
                p_sess = lst_data[2];
                if (session == p_sess) {
                    SnackBar({
                        fixed: true,
                        position: 'bc',
                        message: langpak['key_24'],
                        status: "info"
                    });
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                }

            } else if(ws_data.startsWith('del_all_px')) {
                lst_data = ws_data.split(';');
                p_sess = lst_data[2];
                if (session == p_sess) {
                    data = {};
                    place_current_size = place_draw(ctx, data, currentZoom, px_x, px_y, place_current_size, false, false);
                    SnackBar({
                        fixed: true,
                        position: 'bc',
                        message: langpak['key_25'],
                        status: "info"
                    });
                }

            } else if(ws_data.startsWith('place_create')) {

                lst_data = ws_data.split(';');
                p_sess = lst_data[1];
                SnackBar({
                    fixed: true,
                    position: 'bc',
                    message: langpak['key_26'] + p_sess + langpak['key_27'],
                    status: "info",
                    timeout: 0
                });
                setTimeout(function() {
                    location.reload();
                }, 5000);

            } else {
                console.log(ws_data);
            }
        }

        wsocket.onclose = function (msg) {
            $("section").fadeOut(300);
            SnackBar({
                fixed: true,
                position: 'bc',
                message: langpak['key_28'],
                status: "warning"
            });
            setTimeout(function() {
                location.reload();
            }, 5000);
        };

        // place init data
        var data = {
            "1-1": {
                "color": "#2196f3",
                "user": user,
                "price": 1,
                "last_update": new Date().toLocaleString()
            }
        }

        function place_draw(ctx, data, px_size, px_x, px_y, place_current_size, first_load=false, zoom=false) {
            var place_w = parseInt(px_size * px_x, 10);
            var place_h = parseInt(px_size * px_y, 10);

            ctx.canvas.height=place_h,ctx.canvas.width=place_w,ctx.lineWidth=1,ctx.strokeStyle="#00000020";
            var nb_l=parseInt(place_h/px_size,10),nb_c=parseInt(place_w/px_size,10),cnt_l=0,cnt_c=0;

            for(;cnt_l<=nb_l;)ctx.beginPath(),ctx.moveTo(0,px_size*cnt_l),ctx.lineTo(place_w,px_size*cnt_l),ctx.stroke(),cnt_l++;
            for(;cnt_c<=nb_c;)ctx.beginPath(),ctx.moveTo(px_size*cnt_c,0),ctx.lineTo(px_size*cnt_c,place_h),ctx.stroke(),cnt_c++;

            $.map(data, function(values, key) {
                poss = key.split('-')
                ctx.fillStyle = values['color'];
                ctx.fillRect(poss[0] * currentZoom, poss[1] * currentZoom, currentZoom, currentZoom);
            });

            if (first_load) {
                position = localStorage.getItem('position');
                if(position) {
                    position = position.split(';');
                    $('#place').css({'left': parseFloat(position[0]), 'top': parseFloat(position[1])});
                } else {
                    $("#place").css("top","calc(50% - "+place_h/2+"px)").css("left","calc(50% - "+place_w/2+"px)");
                }
                $("#session").fadeIn(300);
            } else if (zoom) {
                position = $("#place").position();
                position = [position.top, position.left];

                var w = parseInt(place_current_size[0], 10);
                var h = parseInt(place_current_size[1], 10);

                // 3- zoom in / +1 zoom out
                var cur_w = (3 - ((200 * mouseX / window.innerWidth) / 100)).toFixed(3);
                var cur_h = (3 - ((200 * mouseY / window.innerHeight) / 100)).toFixed(3);

                var calc_w = parseInt(position[1] - ((place_w - place_current_size[0]) / cur_w), 10)
                var calc_h = parseInt(position[0] - ((place_h - place_current_size[1]) / cur_h), 10)

                // recadrage pour le zoom
                $("#place").css("top",calc_h.toString()+"px").css("left",calc_w.toString()+"px");

                position = calc_h.toString() + ';' + calc_w.toString();
                localStorage.setItem("position", position);
            }
            return [place_w, place_h];
        }

        zoom = localStorage.getItem('zoom');
        if(zoom) {
            currentZoom = parseInt(zoom,10);
        }

        // zoom
        function zoomUp() {
            place_current_size = place_draw(ctx, data, (currentZoom += 1), px_x, px_y, place_current_size, false, true);
            if (currentZoom > maxZoom) {
                currentZoom = maxZoom;
                place_current_size = place_draw(ctx, data, currentZoom, px_x, px_y, place_current_size, false, true);
            }
            localStorage.setItem("zoom", currentZoom.toString());
        }

        function zoomDown() {
            place_current_size = place_draw(ctx, data, (currentZoom -= 1), px_x, px_y, place_current_size, false, true);
            if (currentZoom < minZoom) {
                currentZoom = minZoom;
                place_current_size = place_draw(ctx, data, currentZoom, px_x, px_y, place_current_size, false, true);
            }
            localStorage.setItem("zoom", currentZoom.toString());
        }

        $(document).bind('mousewheel DOMMouseScroll', function(e){
            if(e.originalEvent.wheelDelta /120 > 0) {
                zoomUp();
            }
            else{
                zoomDown();
            }
            localStorage.setItem("zoom", currentZoom.toString());
        }).on("mousedown", function (e1) {
            $(document).one("mouseup", function (e2) {
                e2.preventDefault();
                if (e1.which == 2 && e1.target == e2.target) {
                    currentZoom = 5;
                    place_current_size = place_draw(ctx, data, currentZoom, px_x, px_y, place_current_size, false, true);
                    localStorage.setItem("zoom", currentZoom.toString());
                    razPos();
                }
            });
        });

        // color pic
        $(".colorPickSelector").colorPick({initialColor:initColor,allowRecent:!0,recentMax:5,allowCustomColor:!0,palette:["#f44336","#e91e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#4caf50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722","#795548","#9e9e9e","#607d8b","#000000", "#ffffff"],onColorSelected:function(){this.element.css({backgroundColor:this.color,color:this.color}),currentColor=this.color,localStorage.setItem("color",currentColor)}});

        // add px
        function getCursorPosition(canvas, event, drop=false) {
            if (!writing) {
                return;
            }
            const rect = canvas.getBoundingClientRect()
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;
            x = parseInt(x, 10) - (x % currentZoom);
            y = parseInt(y, 10) - (y % currentZoom);

            ctx.fillStyle = currentColor;
            ctx.fillRect(Math.ceil(x), Math.ceil(y), currentZoom, currentZoom);

            poss = Math.ceil(x/currentZoom).toString() + '-' + Math.ceil(y/currentZoom).toString();

            if (drop) {
                if (poss in data) {
                    wsocket.send("remove;" + user + ";" + session + ";" + poss);
                    delete data[poss];
                    place_draw(ctx, data, currentZoom, px_x, px_y, place_current_size, false, false);
                }
            } else {
                data[poss] = {
                    "color": currentColor,
                    "user": user,
                    "price": 1,
                    "last_update": new Date().toLocaleString()
                }
                wsocket.send("add;" + user + ";" + session + ";" + poss + ";" + JSON.stringify(data[poss]));
            }
            $.map(data, function(values, key) {
                poss = key.split('-')
                ctx.fillStyle = values['color'];
                ctx.fillRect(poss[0] * currentZoom, poss[1] * currentZoom, currentZoom, currentZoom);
            });
        }

        const canvas = document.querySelector('canvas');
        canvas.addEventListener('dblclick', function(e) {
            getCursorPosition(canvas, e);
        })

        canvas.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            getCursorPosition(canvas, e, true);
        })

        // cursor tracking ---------------------------------->
        $("#place").mousemove(function(e) {
            const rect = canvas.getBoundingClientRect()
            var clientX = event.clientX;
            var clientY = event.clientY;

            var x = clientX - rect.left;
            var y = clientY - rect.top;
            x = parseInt((x/currentZoom)+1, 10);
            y = parseInt((y/currentZoom)+1, 10);

            key = parseInt(x - 1, 10).toString() + "-" + parseInt(y - 1, 10).toString();
            $("#poss_info").html("x: " + x.toString() + " | y: " + y.toString());

            if(key in data) {
                html = "<div>" + langpak['key_29'] + data[key]['color'] + "</div>";
                // html += "<div>" + langpak['key_30'] + data[key]['user'] + "</div>";
                // html += "<div>" + langpak['key_31'] + data[key]['price'] + "</div>";
                html += "<div>" + langpak['key_32'] + data[key]['last_update'] + "</div>";
                $("#px_info").css("top",clientY.toString()+"px").css("left",clientX.toString()+"px").html(html).css("opacity", "0.8");
            } else {
                $("#px_info").css("opacity", "0.0").html("");
            }

        }).mouseleave(function() {
            $("#poss_info").html("");
            $("#px_info").css("opacity", "0.0").html("");
        });
        // cursor tracking ---------------------------------->

        // interface actions
        $(document).ready(function(){
            $( "#place" ).draggable({
                drag: function(event,ui){
                    position = parseInt(ui.position['left'], 10).toString() + ';' + parseInt(ui.position['top'], 10).toString()
                    localStorage.setItem("position", position);
                },
                start: function(event,ui) {
                    clicked = false;
                }
            }).click(function(){
                clicked = true;
            }).dblclick(function(){
                clicked = true;
            });
            $(document).mousemove((function(e){mouseX=e.pageX,mouseY=e.pageY})).mouseover();
        });
        wsocket.onopen = (event) => {
            wsocket.send("load;" + user + ";" + session);
        };
    } else if (user) {
        var redirect = localStorage.getItem("redirect");
        if (redirect) {
            window.location.hash = redirect;
            location.reload();
            localStorage.removeItem("redirect");
        }

        $("#home").append("<button id='logout' class='rth' onclick='getLogout();' title='" + langpak['key_33'] + "'>" + langpak['key_34'] + pseudo + "</button>")


        $("#home .title").delay(500).animate({'opacity': 1.0}, 300);
        $("#go_auth, #go_gest").remove();
        $("#go_place, #new_session").show();
        $("#go_place").click(function() {
            getPlace();
        });
        $("#new_session").keypress(function(event){
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if(keycode == '13') {
                window.location.hash = "#" + $("#new_session").val();
                location.reload();
            }
        }).focus();
    }
</script>


</html>